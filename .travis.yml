sudo: required
language: python

services:
  - docker

before_install:
  - git remote set-branches --add origin master
  - git fetch

jobs:
  include:
    # Building Docker
    - stage: build docker image
      script: 
       - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
       - ./scripts/is_change_in_subproject.py backend && \
          cd backend && \
          docker -f Dockerfile_api build -t backend_test . && \
          dockre tag backend_test $DOCKER_USERNAME/backend_test && \
          docker push $DOCKER_USERNAME/backend_test
         || echo "Skipping..."

    # Testing inside of the Docker
    - stage: test
      script:
       - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
       - ./scripts/is_change_in_subproject.py backend && \
          cd backend && \
          docker run $DOCKER_USERNAME/backend/data_labeling_api make test \
         || echo "Skipping..."

